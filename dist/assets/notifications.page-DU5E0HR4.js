import{G as e,r as t,U as a,b as r,g as s,q as l,j as i,e as n,E as o,A as c,m as d,L as m,a as u,n as x}from"./index-CuIw7dka.js";import{j as g,k as h,l as f,m as y,n as p}from"./index-Byxp-0VZ.js";import{u as b}from"./index-BAG7TkaQ.js";function k(t){return e({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M257 120.471c7.083 0 23.911 4.479 23.911 4.479 45.589 10.447 77.678 52.439 77.678 99.85V352.412l9.321 9.364 7.788 7.823H136.302l7.788-7.823 9.321-9.364V224.8c0-47.41 32.089-89.403 77.678-99.85 0 0 18.043-4.479 23.911-4.479M256 48c-17.602 0-31.059 13.518-31.059 31.2v14.559c-59.015 13.523-103.53 67.601-103.53 131.041v114.4L80 380.8v20.8h352v-20.8l-41.411-41.6V224.8c0-63.44-44.516-117.518-103.53-131.041V79.2c0-17.682-13.457-31.2-31.059-31.2zm41.411 374.4h-82.823c0 22.881 18.633 41.6 41.412 41.6s41.411-18.719 41.411-41.6z"},child:[]}]})(t)}function v(t){return e({attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M12.354 4.354a.5.5 0 0 0-.708-.708L5 10.293 1.854 7.146a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0zm-4.208 7-.896-.897.707-.707.543.543 6.646-6.647a.5.5 0 0 1 .708.708l-7 7a.5.5 0 0 1-.708 0"},child:[]},{tag:"path",attr:{d:"m5.354 7.146.896.897-.707.707-.897-.896a.5.5 0 1 1 .708-.708"},child:[]}]})(t)}function j(t){return e({attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"},child:[]}]})(t)}const N=()=>{const[e,N]=t.useState([]),[w,_]=t.useState(1),[C,$]=t.useState(!0),[S,M]=t.useState(!1),[E,A]=t.useState(!0),[L,z]=t.useState(null),[R,U]=t.useState(null),[D,F]=t.useState(!1),[I,T]=t.useState(!1),[V,B]=t.useState(0),[P,q]=t.useState("all"),{userAuth:G,userAuth:{_id:H}}=t.useContext(a),{socket:W}=r(),J=s(),[K,O]=b({threshold:.1,rootMargin:"100px 0px 0px 0px"}),Q=t.useRef(!1),X=t.useRef(1),Y=t.useRef(!0);t.useEffect(()=>{Q.current=S},[S]),t.useEffect(()=>{X.current=w},[w]),t.useEffect(()=>{Y.current=C},[C]);const Z=t.useCallback((e,t=100)=>{if(!e)return"";const a=e.replace(/[#*`~>]/g,"").trim();return a.length<=t?a:`${a.substring(0,t)}...`},[]),ee=t.useCallback(e=>{const t=Math.floor((Date.now()-new Date(e))/1e3);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:t<604800?`${Math.floor(t/86400)}d ago`:new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})},[]),te=t.useCallback(e=>{try{if(e.blog){const t=`/post/${e.blog.blog_id||e.blog._id||e.blogSlug}`;return"comment_like"!==e.type&&"comment"!==e.type&&"reply"!==e.type||!e.comment?t:`${t}#comment-${e.comment._id}`}}catch(t){}return"#"},[]),ae=t.useMemo(()=>l.debounce(async(e,t=!1)=>{var a,r;if(!Q.current||t){M(!0),z(null);try{const{data:t}=await u.post("/notifications",{page:e,limit:15,filter_type:"all"!==P?P:void 0}),a=Array.isArray(t.notifications)?t.notifications:[];if(N(t=>{if(1===e)return a;{const e=[...t,...a],r=new Map;return e.forEach(e=>{e._id&&!r.has(e._id)&&r.set(e._id,e)}),Array.from(r.values())}}),$(!1!==t.hasMore&&a.length>0),1===e){const e=a.filter(e=>!e.seen).length;B(e)}}catch(s){const e=(null==(r=null==(a=s.response)?void 0:a.data)?void 0:r.error)||"Failed to load notifications";z(e),t||x.error("Couldn't load notifications")}finally{M(!1),A(!1)}}},300),[P]);t.useEffect(()=>{G.access_token&&(_(1),N([]),$(!0),A(!0),ae(1))},[G.access_token,ae,P]),t.useEffect(()=>{if(O&&!S&&C){const e=X.current+1;_(e),ae(e)}},[O,S,C,ae]),t.useEffect(()=>{if(W&&H){const e=e=>{var t;const a=(null==(t=e.user)?void 0:t.username)||e.actorUsername||"Someone",r={like:`â¤ï¸ ${a} liked your post`,comment:`ðŸ’¬ ${a} commented: "${Z(e.extractedContent,50)}"`,reply:`â†©ï¸ ${a} replied: "${Z(e.extractedContent,50)}"`,comment_like:`ðŸ‘ ${a} liked your comment`};x.success(r[e.type]||`ðŸ”” New notification from ${a}`),N(t=>"all"!==P&&e.type!==P||t.find(t=>t._id===e._id)?t:[e,...t]),B(e=>e+1)};return W.on("new_notification",e),W.emit("joinNotificationRoom",{userId:H}),()=>{W.off("new_notification",e),W.emit("leaveNotificationRoom",{userId:H})}}},[W,H,Z,P]);const re=async(e=null)=>{try{e?(N(t=>t.map(t=>t._id===e?{...t,seen:!0}:t)),B(e=>Math.max(0,e-1)),await u.post("/notifications/mark-seen",{notificationId:e,seen:!0})):(F(!0),N(e=>e.map(e=>({...e,seen:!0}))),B(0),await u.post("/notifications/mark-all-seen",{}),x.success("All notifications marked as read"))}catch(t){x.error("Failed to update notifications"),e&&(N(t=>t.map(t=>t._id===e?{...t,seen:!1}:t)),B(e=>e+1))}finally{F(!1),U(null)}},se=t.useMemo(()=>{let t=e;return"all"!==P&&(t=e.filter(e=>"like"===P?"like"===e.type||"comment_like"===e.type:"comment"===P?"comment"===e.type:"reply"!==P||"reply"===e.type)),t.map(e=>{var t,a,r,s,l,i,n;const o=e.extractedContent||(null==(t=e.comment)?void 0:t.comment)||(null==(a=e.reply)?void 0:a.comment)||(null==(r=e.comment_like)?void 0:r.comment)||"";return{...e,id:e._id,username:e.actorUsername||(null==(s=e.user)?void 0:s.username)||"someone",fullname:e.actorFullname||(null==(l=e.user)?void 0:l.fullname)||"Someone",avatarUrl:e.actorProfileImg||(null==(i=e.user)?void 0:i.profile_img)||"/default-avatar.png",content:o,truncatedContent:Z(o,120),timeAgo:ee(e.createdAt),link:te(e),blogTitle:e.blogTitle||(null==(n=e.blog)?void 0:n.title)||"your post"}})},[e,Z,ee,te,P]);t.useEffect(()=>{document.title=V>0?`(${V}) Notifications | Shums`:"Notifications | Shums"},[V]);t.useEffect(()=>{const e=()=>U(null);return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[]);return E?i.jsx("div",{className:"max-w-3xl mx-auto bg-white dark:bg-dark-grey min-h-screen flex items-center justify-center",children:i.jsxs("div",{className:"text-center",children:[i.jsx(n,{}),i.jsx("p",{className:"text-gray-500 mt-4",children:"Loading notifications..."})]})}):i.jsxs("div",{className:"max-w-3xl mx-auto min-h-screen bg-white dark:bg-dark-grey",children:[i.jsx("header",{className:"sticky top-0 z-30 bg-white/95 dark:bg-dark-grey/95 backdrop-blur-sm border-b border-gray-100 dark:border-grey p-4",children:i.jsxs("div",{className:"flex flex-col gap-4",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Notifications"}),V>0&&i.jsxs("span",{className:"bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse",children:[V," new"]})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("button",{onClick:()=>re(),disabled:D||0===V,className:"p-2 text-gray-500 hover:text-primary hover:bg-gray-100 dark:hover:bg-grey rounded-full transition-all",title:"Mark all as read",children:i.jsx(g,{className:"text-lg"})}),i.jsx("button",{onClick:async()=>{if(e.some(e=>e.seen)){if(window.confirm("Clear all read notifications? This action cannot be undone."))try{T(!0),await u.delete("/notifications/clear-seen"),N(e=>e.filter(e=>!e.seen)),x.success("Cleared read notifications")}catch(t){x.error("Failed to clear notifications")}finally{T(!1)}}else x.error("No read notifications to clear")},disabled:I||!e.some(e=>e.seen),className:"p-2 text-gray-500 hover:text-orange-500 hover:bg-gray-100 dark:hover:bg-grey rounded-full transition-all",title:"Clear read",children:i.jsx(h,{className:"text-lg"})})]})]}),i.jsx("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar pb-1",children:[{id:"all",label:"All"},{id:"like",label:"Likes"},{id:"comment",label:"Comments"},{id:"reply",label:"Replies"}].map(e=>i.jsx("button",{onClick:()=>q(e.id),className:"px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all "+(P===e.id?"bg-black text-white dark:bg-white dark:text-black shadow-md":"bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-grey dark:text-gray-300 dark:hover:bg-gray-700"),children:e.label},e.id))})]})}),L?i.jsx(o,{message:L,onRetry:()=>{_(1),z(null),ae(1,!0)}}):i.jsxs("div",{className:"pb-20",children:[0===se.length?i.jsxs("div",{className:"flex flex-col items-center justify-center py-20 px-4 text-center",children:[i.jsx("div",{className:"w-20 h-20 bg-gray-50 dark:bg-grey rounded-full flex items-center justify-center mb-6",children:i.jsx(k,{className:"text-gray-300 text-4xl"})}),i.jsx("h3",{className:"text-xl font-bold text-gray-900 dark:text-white mb-2",children:"No notifications yet"}),i.jsx("p",{className:"text-gray-500 dark:text-gray-400 max-w-sm",children:"all"===P?"When someone interacts with your content, you'll see it here.":`No ${P} notifications found.`})]}):i.jsx(c,{mode:"popLayout",children:se.map(e=>i.jsx(d.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.2},className:"group border-b border-gray-100 dark:border-grey transition-all duration-200 "+(e.seen?"bg-white dark:bg-dark-grey hover:bg-gray-50 dark:hover:bg-black/20":"bg-blue-50/30 dark:bg-blue-900/10"),children:i.jsxs("div",{className:"p-5 flex gap-4",children:[i.jsx("div",{className:"flex-shrink-0 pt-1",children:i.jsxs(m,{to:`/user/${e.username}`,className:"block relative",children:[i.jsx("img",{src:e.avatarUrl,alt:e.fullname,className:"h-10 w-10 rounded-full object-cover border border-gray-200 dark:border-grey shadow-sm",onError:e=>{e.target.src="/default-avatar.png"}}),i.jsxs("div",{className:"absolute -bottom-1 -right-1 bg-white dark:bg-dark-grey rounded-full p-0.5 shadow-sm",children:["like"===e.type&&i.jsx("div",{className:"p-1 bg-red-100 text-red-500 rounded-full",children:i.jsx(f,{size:10})}),"comment"===e.type&&i.jsx("div",{className:"p-1 bg-blue-100 text-blue-500 rounded-full",children:i.jsx(y,{size:10})}),"reply"===e.type&&i.jsx("div",{className:"p-1 bg-green-100 text-green-500 rounded-full",children:i.jsx(p,{size:10})})]})]})}),i.jsx("div",{className:"flex-1 min-w-0",children:i.jsxs("div",{className:"flex items-start justify-between gap-2",children:[i.jsxs("div",{className:"flex-1",children:[i.jsxs("div",{className:"mb-1",children:[i.jsx("span",{className:"text-gray-900 dark:text-white font-medium hover:underline cursor-pointer",onClick:()=>J(`/user/${e.username}`),children:e.fullname}),i.jsxs("span",{className:"text-gray-500 dark:text-gray-400 text-sm ml-1",children:["like"===e.type&&"liked your post","comment"===e.type&&"commented on","reply"===e.type&&"replied to you on","comment_like"===e.type&&"liked your comment on"]}),i.jsx(m,{to:e.link,className:"text-gray-900 dark:text-white font-medium hover:text-primary ml-1 transition-colors",children:e.blogTitle})]}),e.content&&("comment"===e.type||"reply"===e.type)&&i.jsx(m,{to:e.link,className:"block mt-2 p-3 bg-gray-50 dark:bg-grey/50 rounded-lg border border-gray-100 dark:border-grey/50 hover:border-gray-300 dark:hover:border-grey transition-colors group-hover:bg-white dark:group-hover:bg-grey",children:i.jsxs("p",{className:"text-gray-700 dark:text-gray-300 text-sm italic line-clamp-2",children:['"',e.content,'"']})}),i.jsxs("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-400",children:[i.jsx("span",{children:e.timeAgo}),!e.seen&&i.jsx("span",{className:"w-2 h-2 bg-blue-500 rounded-full"})]})]}),i.jsxs("div",{className:"relative opacity-0 group-hover:opacity-100 transition-opacity",children:[i.jsx("button",{onClick:t=>{t.stopPropagation(),U(R===e.id?null:e.id)},className:"p-2 hover:bg-gray-100 dark:hover:bg-grey rounded-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200",children:i.jsx(j,{})}),i.jsx(c,{children:R===e.id&&i.jsx(d.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"absolute right-0 top-full mt-1 w-40 bg-white dark:bg-grey shadow-xl rounded-xl border border-gray-100 dark:border-gray-700 z-50 overflow-hidden",children:i.jsxs("button",{onClick:()=>{re(e.id),U(null)},className:"flex items-center gap-2 w-full text-left px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-dark-grey transition-colors text-gray-700 dark:text-gray-200",children:[i.jsx(v,{}),"Mark as ",e.seen?"unread":"read"]})})})]})]})})]})},e.id))}),S&&i.jsx("div",{className:"p-4",children:i.jsx(n,{})}),!S&&C&&i.jsx("div",{ref:K,className:"h-4"})]})]})};export{N as default};
