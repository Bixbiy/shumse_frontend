import{r as e,U as t,b as s,g as a,q as n,j as l,e as i,E as r,A as o,m as c,L as d,a as m,n as x}from"./index-BK9O-y3K.js";import{f as u,g as h,h as f,i as g,j as p}from"./index-Ce8XiRW5.js";import{G as b}from"./iconBase-BgOIwoCW.js";import{u as j}from"./index-Ydo1i-SF.js";function y(e){return b({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M257 120.471c7.083 0 23.911 4.479 23.911 4.479 45.589 10.447 77.678 52.439 77.678 99.85V352.412l9.321 9.364 7.788 7.823H136.302l7.788-7.823 9.321-9.364V224.8c0-47.41 32.089-89.403 77.678-99.85 0 0 18.043-4.479 23.911-4.479M256 48c-17.602 0-31.059 13.518-31.059 31.2v14.559c-59.015 13.523-103.53 67.601-103.53 131.041v114.4L80 380.8v20.8h352v-20.8l-41.411-41.6V224.8c0-63.44-44.516-117.518-103.53-131.041V79.2c0-17.682-13.457-31.2-31.059-31.2zm41.411 374.4h-82.823c0 22.881 18.633 41.6 41.412 41.6s41.411-18.719 41.411-41.6z"},child:[]}]})(e)}function v(e){return b({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M256 464c22.779 0 41.411-18.719 41.411-41.6h-82.823c0 22.881 18.633 41.6 41.412 41.6zm134.589-124.8V224.8c0-63.44-44.516-117.518-103.53-131.041V79.2c0-17.682-13.457-31.2-31.059-31.2s-31.059 13.518-31.059 31.2v14.559c-59.015 13.523-103.53 67.601-103.53 131.041v114.4L80 380.8v20.8h352v-20.8l-41.411-41.6z"},child:[]}]})(e)}function N(e){return b({attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M12.354 4.354a.5.5 0 0 0-.708-.708L5 10.293 1.854 7.146a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0zm-4.208 7-.896-.897.707-.707.543.543 6.646-6.647a.5.5 0 0 1 .708.708l-7 7a.5.5 0 0 1-.708 0"},child:[]},{tag:"path",attr:{d:"m5.354 7.146.896.897-.707.707-.897-.896a.5.5 0 1 1 .708-.708"},child:[]}]})(e)}function w(e){return b({attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"},child:[]}]})(e)}const k=()=>{const[b,k]=e.useState([]),[C,M]=e.useState(1),[_,$]=e.useState(!0),[S,E]=e.useState(!1),[A,L]=e.useState(!0),[V,z]=e.useState(null),[R,U]=e.useState(null),[B,T]=e.useState(!1),[D,F]=e.useState(!1),[I,P]=e.useState(0),{userAuth:q,userAuth:{_id:G}}=e.useContext(t),{socket:H}=s(),W=a(),[Y,J]=j({threshold:.1,rootMargin:"100px 0px 0px 0px"}),K=e.useRef(!1),O=e.useRef(1),Q=e.useRef(!0);e.useEffect(()=>{K.current=S},[S]),e.useEffect(()=>{O.current=C},[C]),e.useEffect(()=>{Q.current=_},[_]);const X=e.useCallback((e,t=100)=>{if(!e)return"";const s=e.replace(/[#*`~>]/g,"").trim();return s.length<=t?s:`${s.substring(0,t)}...`},[]),Z=e.useCallback(e=>{const t=Math.floor((Date.now()-new Date(e))/1e3);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:t<604800?`${Math.floor(t/86400)}d ago`:new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})},[]),ee=e.useCallback(e=>{try{if(e.blog){const t=`/post/${e.blog.blog_id||e.blog._id||e.blogSlug}`;return"comment_like"!==e.type&&"comment"!==e.type&&"reply"!==e.type||!e.comment?t:`${t}#comment-${e.comment._id}`}}catch(t){}return"#"},[]),te=e.useMemo(()=>n.debounce(async(e,t=!1)=>{var s,a;if(!K.current||t){E(!0),z(null);try{const{data:t}=await m.post("/notifications",{page:e,limit:15}),s=Array.isArray(t.notifications)?t.notifications:[];k(t=>{if(1===e)return s;{const e=[...t,...s],a=new Map;return e.forEach(e=>{e._id&&!a.has(e._id)&&a.set(e._id,e)}),Array.from(a.values())}}),$(!1!==t.hasMore&&s.length>0);const a=s.filter(e=>!e.seen).length;1===e&&P(a)}catch(n){const e=(null==(a=null==(s=n.response)?void 0:s.data)?void 0:a.error)||"Failed to load notifications";z(e),t||x.error("Couldn't load notifications")}finally{E(!1),L(!1)}}},300),[]);e.useEffect(()=>{q.access_token&&(M(1),k([]),$(!0),L(!0),te(1))},[q.access_token,te]),e.useEffect(()=>{if(J&&!S&&_&&1===O.current){const e=O.current+1;M(e),te(e)}},[J,S,_,te]),e.useEffect(()=>{if(H&&G){const e=e=>{var t;const s=(null==(t=e.user)?void 0:t.username)||e.actorUsername||"Someone",a={like:`â¤ï¸ ${s} liked your post`,comment:`ðŸ’¬ ${s} commented: "${X(e.extractedContent,50)}"`,reply:`â†©ï¸ ${s} replied: "${X(e.extractedContent,50)}"`,comment_like:`ðŸ‘ ${s} liked your comment`};x.success(a[e.type]||`ðŸ”” New notification from ${s}`),k(t=>t.find(t=>t._id===e._id)?t:[e,...t]),P(e=>e+1)};return H.on("new_notification",e),H.emit("joinNotificationRoom",{userId:G}),()=>{H.off("new_notification",e),H.emit("leaveNotificationRoom",{userId:G})}}},[H,G,X]);const se=async(e=null)=>{try{e?(k(t=>t.map(t=>t._id===e?{...t,seen:!0}:t)),P(e=>Math.max(0,e-1)),await m.post("/notifications/mark-seen",{notificationId:e,seen:!0}),x.success("Marked as read")):(T(!0),k(e=>e.map(e=>({...e,seen:!0}))),P(0),await m.post("/notifications/mark-all-seen",{}),x.success("All notifications marked as read"))}catch(t){x.error("Failed to update notifications"),e&&(k(t=>t.map(t=>t._id===e?{...t,seen:!1}:t)),P(e=>e+1))}finally{T(!1),U(null)}};e.useCallback(e=>({comment:{icon:l.jsx(f,{className:"text-blue-500"}),color:"bg-blue-500/10 text-blue-600",bg:"bg-blue-500"},like:{icon:l.jsx(g,{className:"text-red-500"}),color:"bg-red-500/10 text-red-600",bg:"bg-red-500"},reply:{icon:l.jsx(p,{className:"text-green-500"}),color:"bg-green-500/10 text-green-600",bg:"bg-green-500"},comment_like:{icon:l.jsx(g,{className:"text-pink-500"}),color:"bg-pink-500/10 text-pink-600",bg:"bg-pink-500"}}[e]||{icon:l.jsx(y,{className:"text-purple-500"}),color:"bg-purple-500/10 text-purple-600",bg:"bg-purple-500"}),[]);const ae=e.useMemo(()=>b.map(e=>{var t,s,a,n,l,i,r;const o=e.extractedContent||(null==(t=e.comment)?void 0:t.comment)||(null==(s=e.reply)?void 0:s.comment)||(null==(a=e.comment_like)?void 0:a.comment)||"Left a comment";return{...e,id:e._id,username:e.actorUsername||(null==(n=e.user)?void 0:n.username)||"someone",fullname:e.actorFullname||(null==(l=e.user)?void 0:l.fullname)||"Someone",avatarUrl:e.actorProfileImg||(null==(i=e.user)?void 0:i.profile_img)||"/default-avatar.png",content:o,truncatedContent:X(o,120),timeAgo:Z(e.createdAt),link:ee(e),blogTitle:e.blogTitle||(null==(r=e.blog)?void 0:r.title)||"your post"}}),[b,X,Z,ee]);e.useEffect(()=>{document.title=I>0?`(${I}) Notifications | Shumse`:"Notifications | Shumse"},[I]);return e.useEffect(()=>{const e=()=>U(null);return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[]),A?l.jsx("div",{className:"max-w-xl mx-auto bg-white min-h-screen flex items-center justify-center",children:l.jsxs("div",{className:"text-center",children:[l.jsx(i,{}),l.jsx("p",{className:"text-gray-500 mt-4",children:"Loading notifications..."})]})}):l.jsxs("div",{className:"max-w-xl mx-auto bg-white min-h-screen",children:[l.jsx("header",{className:"sticky top-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-100 p-4 shadow-sm",children:l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsxs("div",{className:"relative",children:[l.jsx(v,{className:"text-2xl text-blue-600"}),I>0&&l.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center animate-pulse",children:I})]}),l.jsxs("div",{children:[l.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Notifications"}),l.jsx("p",{className:"text-sm text-gray-500",children:b.length>0?`${b.length} notifications`:"No notifications yet"})]})]}),l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsxs("button",{onClick:()=>se(),disabled:B||0===I,className:"flex items-center gap-2 px-3 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200",children:[l.jsx(u,{className:"text-sm"}),B?"Marking...":"Mark all read"]}),l.jsxs("button",{onClick:async()=>{if(b.some(e=>e.seen)){if(window.confirm("Clear all read notifications? This action cannot be undone."))try{F(!0),await m.delete("/notifications/clear-seen"),k(e=>e.filter(e=>!e.seen)),x.success("Cleared read notifications")}catch(e){x.error("Failed to clear notifications")}finally{F(!1)}}else x.error("No read notifications to clear")},disabled:D||!b.some(e=>e.seen),className:"flex items-center gap-2 px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200",children:[l.jsx(h,{className:"text-sm"}),D?"Clearing...":"Clear read"]})]})]})}),V?l.jsx(r,{message:V,onRetry:()=>{M(1),z(null),te(1,!0)}}):l.jsxs("div",{className:"pb-20",children:[0===ae.length?l.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[l.jsx(y,{className:"text-gray-300 text-6xl mb-4"}),l.jsx("h3",{className:"text-lg font-semibold text-gray-500 mb-2",children:"No notifications yet"}),l.jsx("p",{className:"text-gray-400 text-sm max-w-sm",children:"When someone likes, comments, or interacts with your content, you'll see it here."})]}):l.jsx(o,{children:ae.map((e,t)=>l.jsx(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.3,delay:.05*t},className:"border-b border-gray-100 transition-all duration-200 "+(e.seen?"bg-white hover:bg-gray-50":"bg-blue-50/50"),children:l.jsx("div",{className:"p-4",children:l.jsxs("div",{className:"flex gap-4",children:[l.jsx("div",{className:"flex-shrink-0",children:l.jsx("img",{src:e.avatarUrl,alt:e.fullname,className:"h-12 w-12 rounded-full object-cover border-2 border-white shadow-sm",onError:e=>{e.target.src="/default-avatar.png"}})}),l.jsx("div",{className:"flex-1 min-w-0",children:l.jsxs("div",{className:"flex items-start justify-between gap-2",children:[l.jsxs("div",{className:"flex-1",children:[l.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[l.jsx(d,{to:`/${e.username}`,className:"font-semibold text-gray-900 hover:underline text-sm",children:e.username}),l.jsx("span",{className:"text-gray-500 text-sm",children:"â€¢"}),l.jsx("span",{className:"text-gray-500 text-xs",children:e.timeAgo})]}),l.jsxs("div",{className:"mb-2",children:[l.jsx("p",{className:"text-gray-800 text-sm leading-relaxed",children:e.truncatedContent}),e.blogTitle&&l.jsxs("p",{className:"text-gray-500 text-xs mt-1",children:["on ",l.jsx("span",{className:"font-medium",children:e.blogTitle})]})]}),l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx(d,{to:e.link,className:"text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors",children:"View"}),l.jsx("button",{onClick:()=>se(e.id),className:"text-gray-500 hover:text-gray-700 text-sm transition-colors",children:e.seen?"Mark unread":"Mark read"})]})]}),l.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[!e.seen&&l.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-pulse"}),l.jsxs("div",{className:"relative",children:[l.jsx("button",{onClick:t=>{t.stopPropagation(),U(R===e.id?null:e.id)},className:"p-1 rounded-lg hover:bg-gray-100 transition-colors text-gray-400 hover:text-gray-600",children:l.jsx(w,{className:"w-4 h-4"})}),l.jsx(o,{children:R===e.id&&l.jsxs(c.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-40 py-1",children:[l.jsxs("button",{onClick:()=>{se(e.id),U(null)},className:"flex items-center gap-2 w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition-colors",children:[l.jsx(N,{className:"text-sm"}),"Mark as ",e.seen?"unread":"read"]}),l.jsxs("button",{onClick:()=>{W(e.link),U(null)},className:"flex items-center gap-2 w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition-colors",children:[l.jsx(f,{className:"text-sm"}),"View post"]})]})})]})]})]})})]})})},e.id))}),S&&l.jsx("div",{className:"p-4",children:l.jsx(i,{})}),!S&&_&&l.jsx("div",{ref:Y,className:"h-4"}),!S&&!_&&b.length>0&&l.jsx("div",{className:"p-6 text-center",children:l.jsx("div",{className:"text-gray-400 text-sm",children:"ðŸŽ‰ You're all caught up!"})})]})]})};export{k as default};
