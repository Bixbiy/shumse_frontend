import{r as e,n as r,j as i,F as t}from"./vendor-react-CvqM9zc9.js";import{U as a,a as s,A as l,L as n,s as o}from"./index-kVKNAyzJ.js";import{I as c}from"./Input-CmJAJTUu.js";import{U as m}from"./aws-BlzNu9QY.js";import{l as u}from"./vendor-socket-DIFBDcho.js";import"./vendor-misc-BFmcx_8c.js";import"./vendor-utils-DnwaQ9mb.js";import"./vendor-animation-BFb6eZlp.js";const d=()=>{const{userAuth:d,userAuth:{access_token:f,id:g},setUserAuth:p}=e.useContext(a),[b,h]=e.useState(!0),[x,v]=e.useState(!1),[w,j]=e.useState({fullname:"",email:"",username:"",bio:"",profile_img:""}),[y,k]=e.useState({twitter:"",instagram:"",facebook:"",github:"",linkedin:"",website:""}),[N,_]=e.useState(150),[S,I]=e.useState({fullname:!1,username:!1,bio:!0}),[U,C]=e.useState(!1),[P,A]=e.useState(null),R=e.useRef(),E=e.useRef();e.useEffect(()=>{if(f)return E.current=u("https://spread-server.onrender.com",{auth:{token:`Bearer ${f}`}}),E.current.emit("joinProfileRoom",{userId:g}),E.current.on("profileUpdated",e=>{var i;if(e._id===g){const{personal_info:t,social_links:a}=e;j({fullname:t.fullname,email:t.email,username:t.username,bio:t.bio,profile_img:t.profile_img}),k({twitter:a.twitter||"",instagram:a.instagram||"",facebook:a.facebook||"",github:a.github||"",linkedin:a.linkedin||"",website:a.website||""}),_(150-((null==(i=t.bio)?void 0:i.length)||0)),r.success("Your profile was updated elsewhere, refreshing view.")}}),()=>{E.current&&E.current.disconnect()}},[f,g]),e.useEffect(()=>{f?s.post("/get-profile",{username:d.username}).then(({data:e})=>{var r;const{personal_info:i,social_links:t={}}=e;j({fullname:i.fullname,email:i.email,username:i.username,bio:i.bio,profile_img:i.profile_img}),k({twitter:t.twitter||"",instagram:t.instagram||"",facebook:t.facebook||"",github:t.github||"",linkedin:t.linkedin||"",website:t.website||""}),_(150-((null==(r=i.bio)?void 0:r.length)||0)),h(!1)}).catch(e=>{r.error("Failed to load profile. Please try again.")}):window.location.href="/signin"},[f,d.username]),e.useEffect(()=>{const e=w.fullname.trim().length>=3,r=/^[a-zA-Z0-9_]{3,20}$/.test(w.username),i=w.bio.length<=150;I({fullname:e,username:r,bio:i}),C(e&&r&&i)},[w]);const L=(e,r)=>{j(i=>({...i,[e]:r}))};return b?i.jsxs(l,{children:[i.jsx(t,{position:"top-center"}),i.jsx(n,{})]}):i.jsxs(l,{children:[i.jsx(t,{position:"top-center"}),i.jsx("form",{onSubmit:async e=>{var i,t,a;if(e.preventDefault(),b)return r.error("Loading data, please wait.");if(!U)return r.error("Please fix validation errors before saving.");v(!0);const l={username:w.username.trim(),fullname:w.fullname.trim(),bio:w.bio.trim(),social_links:{twitter:y.twitter.trim(),instagram:y.instagram.trim(),facebook:y.facebook.trim(),github:y.github.trim(),linkedin:y.linkedin.trim(),website:y.website.trim()}};try{await s.post("/update-profile",l),r.success("Profile updated successfully!"),E.current.emit("forceProfileRefresh",{userId:g})}catch(n){if(422===(null==(i=n.response)?void 0:i.status)&&Array.isArray(n.response.data.errors))n.response.data.errors.forEach(e=>{r.error(e)});else{const e=(null==(a=null==(t=n.response)?void 0:t.data)?void 0:a.error)||"An unexpected error occurred while saving.";r.error(e)}}finally{v(!1)}},className:"max-w-3xl  mx-auto px-4 py-10 sm:px-6",children:i.jsxs("div",{className:"bg-white border-4 dark:bg-black/20 shadow-xl rounded-3xl overflow-hidden backdrop-blur-xl ring-1 ring-cyan-100/30",children:[i.jsxs("div",{className:"bg-gradient-to-br from-blue-900 to-indigo-900 text-white p-6 sm:p-8",children:[i.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Edit Profile"}),i.jsx("p",{className:"text-cyan-100 text-sm mt-1",children:"Craft your online identity"})]}),i.jsxs("div",{className:"p-6 space-y-8",children:[i.jsx("div",{className:"flex justify-center",children:i.jsxs("div",{className:"relative group w-32 h-32 sm:w-40 sm:h-40",children:[i.jsx("img",{ref:R,src:w.profile_img||"/default-profile.png",alt:"Profile",className:"w-full h-full object-cover rounded-full border-4 border-white shadow-lg group-hover:scale-105 transition"}),i.jsxs("label",{htmlFor:"profileImg",className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center rounded-full cursor-pointer transition",children:[i.jsx("i",{className:"fi fi-rr-camera text-white text-xl mb-1"}),i.jsx("span",{className:"text-white text-sm",children:"Change"}),i.jsx("input",{type:"file",name:"profileImg",id:"profileImg",accept:".jpeg,.jpg,.png,.webp,.svg",className:"hidden",onChange:e=>{const r=e.target.files[0];r&&(R.current.src=URL.createObjectURL(r),A(r))}})]})]})}),i.jsx("button",{onClick:async e=>{var i;if(e.preventDefault(),!P)return void r.error("Please choose an image first.");const t=r.loading("Uploading image...");try{const e=await m(P);if(!e||!e.url)throw new Error("Upload failed: no URL returned");w.profile_img;j(r=>({...r,profile_img:e.url}));const a={url:e.url,profile_img:e.url};e.public_id&&(a.public_id=e.public_id,a.publicId=e.public_id,a.cloudinary_id=e.public_id);const l=await s.post("/changeImg",a),n=(null==(i=null==l?void 0:l.data)?void 0:i.profile_img)||e.url,c={...d,profile_img:n};o("user",JSON.stringify(c)),p(c),r.dismiss(t),A(null),r.success("Profile image updated!"),E.current.emit("forceProfileRefresh",{userId:g})}catch(a){j(e=>({...e,profile_img:e.profile_img})),r.dismiss(t),r.error("Failed to update image.")}},disabled:!P,className:"btn-dark mt-5 center  lg:w-[50%] px-10 "+(P?"":"opacity-50 cursor-not-allowed"),children:"Upload Image"}),i.jsxs("div",{className:"grid sm:grid-cols-2 gap-6",children:[i.jsx(c,{name:"fullname",type:"text",label:"Full Name",value:w.fullname,onChange:e=>L("fullname",e.target.value),className:"capitalize",icon:"fi-rr-user",validation:S.fullname,helper:S.fullname?"":"Full name must be at least 3 letters."}),i.jsx(c,{name:"email",type:"email",label:"Email",value:w.email,icon:"fi-rr-envelope",validation:!0,readOnly:!0}),i.jsx(c,{name:"username",type:"text",label:"Username",value:w.username,onChange:e=>L("username",e.target.value),icon:"fi-rr-at",validation:S.username,helper:S.username?"":"3–20 chars; letters, numbers, or underscore only."})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-white mb-1",children:"Bio"}),i.jsx("textarea",{name:"bio",value:w.bio,onChange:e=>{L("bio",e.target.value),_(150-e.target.value.length)},maxLength:150,placeholder:"Describe yourself in 150 characters",className:"w-full h-36 p-3 border rounded-xl shadow-sm bg-white/70 focus:ring-2 focus:ring-cyan-500 resize-none "+(S.bio?"":"border-red-400")}),!S.bio&&i.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Bio must be 150 characters or fewer."}),i.jsxs("p",{className:"text-xs mt-1 text-right text-cyan-600",children:[N,"/150"]})]}),i.jsxs("div",{children:[i.jsx("h3",{className:"text-md font-semibold text-gray-800 dark:text-white mb-3",children:"Social Links"}),i.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:Object.entries({twitter:"fi fi-brands-twitter",instagram:"fi fi-brands-instagram",facebook:"fi fi-brands-facebook",github:"fi fi-brands-github",linkedin:"fi fi-brands-linkedin",website:"fi fi-rr-globe"}).map(([e,r])=>i.jsxs("div",{className:"flex items-center space-x-3",children:[i.jsx("i",{className:`${r} text-xl text-cyan-500`}),i.jsx("input",{name:e,type:"url",value:y[e]||"",onChange:r=>((e,r)=>{k(i=>({...i,[e]:r}))})(e,r.target.value),placeholder:`${e}.com/username`,className:"flex-1 p-2 rounded-lg bg-white/80 border focus:ring-cyan-500 focus:ring-2"})]},e))})]}),i.jsx("div",{className:"pt-6 text-right",children:i.jsx("button",{type:"submit",disabled:!U||x,className:"px-8 py-3 rounded-xl text-white font-bold transition-all duration-300 "+(U&&!x?"bg-gradient-to-r from-cyan-500 to-blue-600 hover:scale-105 shadow-md":"bg-gray-400 cursor-not-allowed"),children:x?"Saving…":"Save Changes"})})]})]})})]})};export{d as default};
