import{j as e}from"./vendor-markdown-DVKDwQVh.js";import{r as t,u as s,L as a}from"./vendor-react-B32pNUrn.js";import{U as n,u as i,l,L as r,E as o,a as c}from"./index-D1ni5E-J.js";import{f as d,g as m,h as u,i as x,j as h}from"./index-CIJS504a.js";import{G as f}from"./iconBase-D8qOIRNa.js";import{u as g}from"./index-In3Rit_0.js";import{A as p,m as b,c as j}from"./vendor-ui-BqXYh4xT.js";import"./vendor-socket-CUkmNz_4.js";function v(e){return f({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M257 120.471c7.083 0 23.911 4.479 23.911 4.479 45.589 10.447 77.678 52.439 77.678 99.85V352.412l9.321 9.364 7.788 7.823H136.302l7.788-7.823 9.321-9.364V224.8c0-47.41 32.089-89.403 77.678-99.85 0 0 18.043-4.479 23.911-4.479M256 48c-17.602 0-31.059 13.518-31.059 31.2v14.559c-59.015 13.523-103.53 67.601-103.53 131.041v114.4L80 380.8v20.8h352v-20.8l-41.411-41.6V224.8c0-63.44-44.516-117.518-103.53-131.041V79.2c0-17.682-13.457-31.2-31.059-31.2zm41.411 374.4h-82.823c0 22.881 18.633 41.6 41.412 41.6s41.411-18.719 41.411-41.6z"},child:[]}]})(e)}function y(e){return f({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M256 464c22.779 0 41.411-18.719 41.411-41.6h-82.823c0 22.881 18.633 41.6 41.412 41.6zm134.589-124.8V224.8c0-63.44-44.516-117.518-103.53-131.041V79.2c0-17.682-13.457-31.2-31.059-31.2s-31.059 13.518-31.059 31.2v14.559c-59.015 13.523-103.53 67.601-103.53 131.041v114.4L80 380.8v20.8h352v-20.8l-41.411-41.6z"},child:[]}]})(e)}function N(e){return f({attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M12.354 4.354a.5.5 0 0 0-.708-.708L5 10.293 1.854 7.146a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0zm-4.208 7-.896-.897.707-.707.543.543 6.646-6.647a.5.5 0 0 1 .708.708l-7 7a.5.5 0 0 1-.708 0"},child:[]},{tag:"path",attr:{d:"m5.354 7.146.896.897-.707.707-.897-.896a.5.5 0 1 1 .708-.708"},child:[]}]})(e)}function w(e){return f({attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"},child:[]}]})(e)}const k=()=>{const[f,k]=t.useState([]),[C,M]=t.useState(1),[_,$]=t.useState(!0),[S,E]=t.useState(!1),[A,L]=t.useState(!0),[V,z]=t.useState(null),[R,U]=t.useState(null),[B,T]=t.useState(!1),[D,F]=t.useState(!1),[I,P]=t.useState(0),{userAuth:q,userAuth:{_id:G}}=t.useContext(n),{socket:H}=i(),W=s(),[Y,J]=g({threshold:.1,rootMargin:"100px 0px 0px 0px"}),K=t.useRef(!1),O=t.useRef(1),Q=t.useRef(!0);t.useEffect(()=>{K.current=S},[S]),t.useEffect(()=>{O.current=C},[C]),t.useEffect(()=>{Q.current=_},[_]);const X=t.useCallback((e,t=100)=>{if(!e)return"";const s=e.replace(/[#*`~>]/g,"").trim();return s.length<=t?s:`${s.substring(0,t)}...`},[]),Z=t.useCallback(e=>{const t=Math.floor((Date.now()-new Date(e))/1e3);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:t<604800?`${Math.floor(t/86400)}d ago`:new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})},[]),ee=t.useCallback(e=>{try{if(e.blog){const t=`/post/${e.blog.blog_id||e.blog._id||e.blogSlug}`;return"comment_like"!==e.type&&"comment"!==e.type&&"reply"!==e.type||!e.comment?t:`${t}#comment-${e.comment._id}`}}catch(t){}return"#"},[]),te=t.useMemo(()=>l.debounce(async(e,t=!1)=>{var s,a;if(!K.current||t){E(!0),z(null);try{const{data:t}=await c.post("/notifications",{page:e,limit:15}),s=Array.isArray(t.notifications)?t.notifications:[];k(t=>{if(1===e)return s;{const e=[...t,...s],a=new Map;return e.forEach(e=>{e._id&&!a.has(e._id)&&a.set(e._id,e)}),Array.from(a.values())}}),$(!1!==t.hasMore&&s.length>0);const a=s.filter(e=>!e.seen).length;1===e&&P(a)}catch(n){const e=(null==(a=null==(s=n.response)?void 0:s.data)?void 0:a.error)||"Failed to load notifications";z(e),t||j.error("Couldn't load notifications")}finally{E(!1),L(!1)}}},300),[]);t.useEffect(()=>{q.access_token&&(M(1),k([]),$(!0),L(!0),te(1))},[q.access_token,te]),t.useEffect(()=>{if(J&&!S&&_&&1===O.current){const e=O.current+1;M(e),te(e)}},[J,S,_,te]),t.useEffect(()=>{if(H&&G){const e=e=>{var t;const s=(null==(t=e.user)?void 0:t.username)||e.actorUsername||"Someone",a={like:`â¤ï¸ ${s} liked your post`,comment:`ðŸ’¬ ${s} commented: "${X(e.extractedContent,50)}"`,reply:`â†©ï¸ ${s} replied: "${X(e.extractedContent,50)}"`,comment_like:`ðŸ‘ ${s} liked your comment`};j.success(a[e.type]||`ðŸ”” New notification from ${s}`),k(t=>t.find(t=>t._id===e._id)?t:[e,...t]),P(e=>e+1)};return H.on("new_notification",e),H.emit("joinNotificationRoom",{userId:G}),()=>{H.off("new_notification",e),H.emit("leaveNotificationRoom",{userId:G})}}},[H,G,X]);const se=async(e=null)=>{try{e?(k(t=>t.map(t=>t._id===e?{...t,seen:!0}:t)),P(e=>Math.max(0,e-1)),await c.post("/notifications/mark-seen",{notificationId:e,seen:!0}),j.success("Marked as read")):(T(!0),k(e=>e.map(e=>({...e,seen:!0}))),P(0),await c.post("/notifications/mark-all-seen",{}),j.success("All notifications marked as read"))}catch(t){j.error("Failed to update notifications"),e&&(k(t=>t.map(t=>t._id===e?{...t,seen:!1}:t)),P(e=>e+1))}finally{T(!1),U(null)}};t.useCallback(t=>({comment:{icon:e.jsx(u,{className:"text-blue-500"}),color:"bg-blue-500/10 text-blue-600",bg:"bg-blue-500"},like:{icon:e.jsx(x,{className:"text-red-500"}),color:"bg-red-500/10 text-red-600",bg:"bg-red-500"},reply:{icon:e.jsx(h,{className:"text-green-500"}),color:"bg-green-500/10 text-green-600",bg:"bg-green-500"},comment_like:{icon:e.jsx(x,{className:"text-pink-500"}),color:"bg-pink-500/10 text-pink-600",bg:"bg-pink-500"}}[t]||{icon:e.jsx(v,{className:"text-purple-500"}),color:"bg-purple-500/10 text-purple-600",bg:"bg-purple-500"}),[]);const ae=t.useMemo(()=>f.map(e=>{var t,s,a,n,i,l,r;const o=e.extractedContent||(null==(t=e.comment)?void 0:t.comment)||(null==(s=e.reply)?void 0:s.comment)||(null==(a=e.comment_like)?void 0:a.comment)||"Left a comment";return{...e,id:e._id,username:e.actorUsername||(null==(n=e.user)?void 0:n.username)||"someone",fullname:e.actorFullname||(null==(i=e.user)?void 0:i.fullname)||"Someone",avatarUrl:e.actorProfileImg||(null==(l=e.user)?void 0:l.profile_img)||"/default-avatar.png",content:o,truncatedContent:X(o,120),timeAgo:Z(e.createdAt),link:ee(e),blogTitle:e.blogTitle||(null==(r=e.blog)?void 0:r.title)||"your post"}}),[f,X,Z,ee]);t.useEffect(()=>{document.title=I>0?`(${I}) Notifications | Shumse`:"Notifications | Shumse"},[I]);return t.useEffect(()=>{const e=()=>U(null);return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[]),A?e.jsx("div",{className:"max-w-xl mx-auto bg-white min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(r,{}),e.jsx("p",{className:"text-gray-500 mt-4",children:"Loading notifications..."})]})}):e.jsxs("div",{className:"max-w-xl mx-auto bg-white min-h-screen",children:[e.jsx("header",{className:"sticky top-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-100 p-4 shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(y,{className:"text-2xl text-blue-600"}),I>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center animate-pulse",children:I})]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Notifications"}),e.jsx("p",{className:"text-sm text-gray-500",children:f.length>0?`${f.length} notifications`:"No notifications yet"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>se(),disabled:B||0===I,className:"flex items-center gap-2 px-3 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200",children:[e.jsx(d,{className:"text-sm"}),B?"Marking...":"Mark all read"]}),e.jsxs("button",{onClick:async()=>{if(f.some(e=>e.seen)){if(window.confirm("Clear all read notifications? This action cannot be undone."))try{F(!0),await c.delete("/notifications/clear-seen"),k(e=>e.filter(e=>!e.seen)),j.success("Cleared read notifications")}catch(e){j.error("Failed to clear notifications")}finally{F(!1)}}else j.error("No read notifications to clear")},disabled:D||!f.some(e=>e.seen),className:"flex items-center gap-2 px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200",children:[e.jsx(m,{className:"text-sm"}),D?"Clearing...":"Clear read"]})]})]})}),V?e.jsx(o,{message:V,onRetry:()=>{M(1),z(null),te(1,!0)}}):e.jsxs("div",{className:"pb-20",children:[0===ae.length?e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[e.jsx(v,{className:"text-gray-300 text-6xl mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-500 mb-2",children:"No notifications yet"}),e.jsx("p",{className:"text-gray-400 text-sm max-w-sm",children:"When someone likes, comments, or interacts with your content, you'll see it here."})]}):e.jsx(p,{children:ae.map((t,s)=>e.jsx(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.3,delay:.05*s},className:"border-b border-gray-100 transition-all duration-200 "+(t.seen?"bg-white hover:bg-gray-50":"bg-blue-50/50"),children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:t.avatarUrl,alt:t.fullname,className:"h-12 w-12 rounded-full object-cover border-2 border-white shadow-sm",onError:e=>{e.target.src="/default-avatar.png"}})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(a,{to:`/${t.username}`,className:"font-semibold text-gray-900 hover:underline text-sm",children:t.username}),e.jsx("span",{className:"text-gray-500 text-sm",children:"â€¢"}),e.jsx("span",{className:"text-gray-500 text-xs",children:t.timeAgo})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("p",{className:"text-gray-800 text-sm leading-relaxed",children:t.truncatedContent}),t.blogTitle&&e.jsxs("p",{className:"text-gray-500 text-xs mt-1",children:["on ",e.jsx("span",{className:"font-medium",children:t.blogTitle})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(a,{to:t.link,className:"text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors",children:"View"}),e.jsx("button",{onClick:()=>se(t.id),className:"text-gray-500 hover:text-gray-700 text-sm transition-colors",children:t.seen?"Mark unread":"Mark read"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[!t.seen&&e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-pulse"}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:e=>{e.stopPropagation(),U(R===t.id?null:t.id)},className:"p-1 rounded-lg hover:bg-gray-100 transition-colors text-gray-400 hover:text-gray-600",children:e.jsx(w,{className:"w-4 h-4"})}),e.jsx(p,{children:R===t.id&&e.jsxs(b.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-40 py-1",children:[e.jsxs("button",{onClick:()=>{se(t.id),U(null)},className:"flex items-center gap-2 w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition-colors",children:[e.jsx(N,{className:"text-sm"}),"Mark as ",t.seen?"unread":"read"]}),e.jsxs("button",{onClick:()=>{W(t.link),U(null)},className:"flex items-center gap-2 w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition-colors",children:[e.jsx(u,{className:"text-sm"}),"View post"]})]})})]})]})]})})]})})},t.id))}),S&&e.jsx("div",{className:"p-4",children:e.jsx(r,{})}),!S&&_&&e.jsx("div",{ref:Y,className:"h-4"}),!S&&!_&&f.length>0&&e.jsx("div",{className:"p-6 text-center",children:e.jsx("div",{className:"text-gray-400 text-sm",children:"ðŸŽ‰ You're all caught up!"})})]})]})};export{k as default};
