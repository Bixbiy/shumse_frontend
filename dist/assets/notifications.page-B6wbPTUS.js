import{r as e,u as t,p as s,j as a,I as n,s as i,t as l,v as r,L as o,w as c,x as d,y as m,n as x,A as u,C as f}from"./vendor-react-B97CwnuL.js";import{U as g,u as h,L as p,E as b,a as j}from"./index-RWwxXIM8.js";import{l as y}from"./vendor-utils-8sZVtwSW.js";import{A as v,m as N}from"./vendor-animation-Bq1BCxLt.js";import"./vendor-misc-DLsXWmW-.js";import"./vendor-socket-CKUjeMYl.js";const k=()=>{const[k,w]=e.useState([]),[C,_]=e.useState(1),[$,S]=e.useState(!0),[M,E]=e.useState(!1),[A,L]=e.useState(!0),[R,U]=e.useState(null),[I,T]=e.useState(null),[D,F]=e.useState(!1),[z,P]=e.useState(!1),[V,W]=e.useState(0),{userAuth:Y,userAuth:{_id:q}}=e.useContext(g),{socket:B}=h(),G=t(),[H,J]=s({threshold:.1,rootMargin:"100px 0px 0px 0px"}),K=e.useRef(!1),O=e.useRef(1),Q=e.useRef(!0);e.useEffect(()=>{K.current=M},[M]),e.useEffect(()=>{O.current=C},[C]),e.useEffect(()=>{Q.current=$},[$]);const X=e.useCallback((e,t=100)=>{if(!e)return"";const s=e.replace(/[#*`~>]/g,"").trim();return s.length<=t?s:`${s.substring(0,t)}...`},[]),Z=e.useCallback(e=>{const t=Math.floor((Date.now()-new Date(e))/1e3);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:t<604800?`${Math.floor(t/86400)}d ago`:new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})},[]),ee=e.useCallback(e=>{try{if(e.blog){const t=`/post/${e.blog.blog_id||e.blog._id||e.blogSlug}`;return"comment_like"!==e.type&&"comment"!==e.type&&"reply"!==e.type||!e.comment?t:`${t}#comment-${e.comment._id}`}}catch(t){}return"#"},[]),te=e.useMemo(()=>y.debounce(async(e,t=!1)=>{var s,a;if(!K.current||t){E(!0),U(null);try{const{data:t}=await j.post("/notifications",{page:e,limit:15}),s=Array.isArray(t.notifications)?t.notifications:[];w(t=>{if(1===e)return s;{const e=[...t,...s],a=new Map;return e.forEach(e=>{e._id&&!a.has(e._id)&&a.set(e._id,e)}),Array.from(a.values())}}),S(!1!==t.hasMore&&s.length>0);const a=s.filter(e=>!e.seen).length;1===e&&W(a)}catch(n){const e=(null==(a=null==(s=n.response)?void 0:s.data)?void 0:a.error)||"Failed to load notifications";U(e),t||x.error("Couldn't load notifications")}finally{E(!1),L(!1)}}},300),[]);e.useEffect(()=>{Y.access_token&&(_(1),w([]),S(!0),L(!0),te(1))},[Y.access_token,te]),e.useEffect(()=>{if(J&&!M&&$&&1===O.current){const e=O.current+1;_(e),te(e)}},[J,M,$,te]),e.useEffect(()=>{if(B&&q){const e=e=>{var t;const s=(null==(t=e.user)?void 0:t.username)||e.actorUsername||"Someone",a={like:`â¤ï¸ ${s} liked your post`,comment:`ðŸ’¬ ${s} commented: "${X(e.extractedContent,50)}"`,reply:`â†©ï¸ ${s} replied: "${X(e.extractedContent,50)}"`,comment_like:`ðŸ‘ ${s} liked your comment`};x.success(a[e.type]||`ðŸ”” New notification from ${s}`),w(t=>t.find(t=>t._id===e._id)?t:[e,...t]),W(e=>e+1)};return B.on("new_notification",e),B.emit("joinNotificationRoom",{userId:q}),()=>{B.off("new_notification",e),B.emit("leaveNotificationRoom",{userId:q})}}},[B,q,X]);const se=async(e=null)=>{try{e?(w(t=>t.map(t=>t._id===e?{...t,seen:!0}:t)),W(e=>Math.max(0,e-1)),await j.post("/notifications/mark-seen",{notificationId:e,seen:!0}),x.success("Marked as read")):(F(!0),w(e=>e.map(e=>({...e,seen:!0}))),W(0),await j.post("/notifications/mark-all-seen",{}),x.success("All notifications marked as read"))}catch(t){x.error("Failed to update notifications"),e&&(w(t=>t.map(t=>t._id===e?{...t,seen:!1}:t)),W(e=>e+1))}finally{F(!1),T(null)}};e.useCallback(e=>({comment:{icon:a.jsx(m,{className:"text-blue-500"}),color:"bg-blue-500/10 text-blue-600",bg:"bg-blue-500"},like:{icon:a.jsx(u,{className:"text-red-500"}),color:"bg-red-500/10 text-red-600",bg:"bg-red-500"},reply:{icon:a.jsx(f,{className:"text-green-500"}),color:"bg-green-500/10 text-green-600",bg:"bg-green-500"},comment_like:{icon:a.jsx(u,{className:"text-pink-500"}),color:"bg-pink-500/10 text-pink-600",bg:"bg-pink-500"}}[e]||{icon:a.jsx(n,{className:"text-purple-500"}),color:"bg-purple-500/10 text-purple-600",bg:"bg-purple-500"}),[]);const ae=e.useMemo(()=>k.map(e=>{var t,s,a,n,i,l,r;const o=e.extractedContent||(null==(t=e.comment)?void 0:t.comment)||(null==(s=e.reply)?void 0:s.comment)||(null==(a=e.comment_like)?void 0:a.comment)||"Left a comment";return{...e,id:e._id,username:e.actorUsername||(null==(n=e.user)?void 0:n.username)||"someone",fullname:e.actorFullname||(null==(i=e.user)?void 0:i.fullname)||"Someone",avatarUrl:e.actorProfileImg||(null==(l=e.user)?void 0:l.profile_img)||"/default-avatar.png",content:o,truncatedContent:X(o,120),timeAgo:Z(e.createdAt),link:ee(e),blogTitle:e.blogTitle||(null==(r=e.blog)?void 0:r.title)||"your post"}}),[k,X,Z,ee]);e.useEffect(()=>{document.title=V>0?`(${V}) Notifications | Shumse`:"Notifications | Shumse"},[V]);return e.useEffect(()=>{const e=()=>T(null);return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[]),A?a.jsx("div",{className:"max-w-xl mx-auto bg-white min-h-screen flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx(p,{}),a.jsx("p",{className:"text-gray-500 mt-4",children:"Loading notifications..."})]})}):a.jsxs("div",{className:"max-w-xl mx-auto bg-white min-h-screen",children:[a.jsx("header",{className:"sticky top-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-100 p-4 shadow-sm",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("div",{className:"relative",children:[a.jsx(i,{className:"text-2xl text-blue-600"}),V>0&&a.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center animate-pulse",children:V})]}),a.jsxs("div",{children:[a.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Notifications"}),a.jsx("p",{className:"text-sm text-gray-500",children:k.length>0?`${k.length} notifications`:"No notifications yet"})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("button",{onClick:()=>se(),disabled:D||0===V,className:"flex items-center gap-2 px-3 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200",children:[a.jsx(l,{className:"text-sm"}),D?"Marking...":"Mark all read"]}),a.jsxs("button",{onClick:async()=>{if(k.some(e=>e.seen)){if(window.confirm("Clear all read notifications? This action cannot be undone."))try{P(!0),await j.delete("/notifications/clear-seen"),w(e=>e.filter(e=>!e.seen)),x.success("Cleared read notifications")}catch(e){x.error("Failed to clear notifications")}finally{P(!1)}}else x.error("No read notifications to clear")},disabled:z||!k.some(e=>e.seen),className:"flex items-center gap-2 px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200",children:[a.jsx(r,{className:"text-sm"}),z?"Clearing...":"Clear read"]})]})]})}),R?a.jsx(b,{message:R,onRetry:()=>{_(1),U(null),te(1,!0)}}):a.jsxs("div",{className:"pb-20",children:[0===ae.length?a.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[a.jsx(n,{className:"text-gray-300 text-6xl mb-4"}),a.jsx("h3",{className:"text-lg font-semibold text-gray-500 mb-2",children:"No notifications yet"}),a.jsx("p",{className:"text-gray-400 text-sm max-w-sm",children:"When someone likes, comments, or interacts with your content, you'll see it here."})]}):a.jsx(v,{children:ae.map((e,t)=>a.jsx(N.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.3,delay:.05*t},className:"border-b border-gray-100 transition-all duration-200 "+(e.seen?"bg-white hover:bg-gray-50":"bg-blue-50/50"),children:a.jsx("div",{className:"p-4",children:a.jsxs("div",{className:"flex gap-4",children:[a.jsx("div",{className:"flex-shrink-0",children:a.jsx("img",{src:e.avatarUrl,alt:e.fullname,className:"h-12 w-12 rounded-full object-cover border-2 border-white shadow-sm",onError:e=>{e.target.src="/default-avatar.png"}})}),a.jsx("div",{className:"flex-1 min-w-0",children:a.jsxs("div",{className:"flex items-start justify-between gap-2",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx(o,{to:`/${e.username}`,className:"font-semibold text-gray-900 hover:underline text-sm",children:e.username}),a.jsx("span",{className:"text-gray-500 text-sm",children:"â€¢"}),a.jsx("span",{className:"text-gray-500 text-xs",children:e.timeAgo})]}),a.jsxs("div",{className:"mb-2",children:[a.jsx("p",{className:"text-gray-800 text-sm leading-relaxed",children:e.truncatedContent}),e.blogTitle&&a.jsxs("p",{className:"text-gray-500 text-xs mt-1",children:["on ",a.jsx("span",{className:"font-medium",children:e.blogTitle})]})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(o,{to:e.link,className:"text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors",children:"View"}),a.jsx("button",{onClick:()=>se(e.id),className:"text-gray-500 hover:text-gray-700 text-sm transition-colors",children:e.seen?"Mark unread":"Mark read"})]})]}),a.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[!e.seen&&a.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-pulse"}),a.jsxs("div",{className:"relative",children:[a.jsx("button",{onClick:t=>{t.stopPropagation(),T(I===e.id?null:e.id)},className:"p-1 rounded-lg hover:bg-gray-100 transition-colors text-gray-400 hover:text-gray-600",children:a.jsx(c,{className:"w-4 h-4"})}),a.jsx(v,{children:I===e.id&&a.jsxs(N.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-40 py-1",children:[a.jsxs("button",{onClick:()=>{se(e.id),T(null)},className:"flex items-center gap-2 w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition-colors",children:[a.jsx(d,{className:"text-sm"}),"Mark as ",e.seen?"unread":"read"]}),a.jsxs("button",{onClick:()=>{G(e.link),T(null)},className:"flex items-center gap-2 w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition-colors",children:[a.jsx(m,{className:"text-sm"}),"View post"]})]})})]})]})]})})]})})},e.id))}),M&&a.jsx("div",{className:"p-4",children:a.jsx(p,{})}),!M&&$&&a.jsx("div",{ref:H,className:"h-4"}),!M&&!$&&k.length>0&&a.jsx("div",{className:"p-6 text-center",children:a.jsx("div",{className:"text-gray-400 text-sm",children:"ðŸŽ‰ You're all caught up!"})})]})]})};export{k as default};
