import{r as e,U as r,o as i,n as a,a as t,j as s,d as l,F as n,e as o,s as c}from"./index-BK9O-y3K.js";import{I as u}from"./Input-C1SidNCc.js";import{U as d}from"./aws-B787dLGz.js";const m=()=>{const{userAuth:m,userAuth:{access_token:f,id:g},setUserAuth:p}=e.useContext(r),[b,h]=e.useState(!0),[x,w]=e.useState(!1),[v,j]=e.useState({fullname:"",email:"",username:"",bio:"",profile_img:""}),[y,k]=e.useState({twitter:"",instagram:"",facebook:"",github:"",linkedin:"",website:""}),[N,_]=e.useState(150),[S,I]=e.useState({fullname:!1,username:!1,bio:!0}),[U,C]=e.useState(!1),[P,R]=e.useState(null),A=e.useRef(),E=e.useRef();e.useEffect(()=>{if(f)return E.current=i("https://spread-server-528420849904.europe-west1.run.app",{auth:{token:`Bearer ${f}`}}),E.current.emit("joinProfileRoom",{userId:g}),E.current.on("profileUpdated",e=>{var r;if(e._id===g){const{personal_info:i,social_links:t}=e;j({fullname:i.fullname,email:i.email,username:i.username,bio:i.bio,profile_img:i.profile_img}),k({twitter:t.twitter||"",instagram:t.instagram||"",facebook:t.facebook||"",github:t.github||"",linkedin:t.linkedin||"",website:t.website||""}),_(150-((null==(r=i.bio)?void 0:r.length)||0)),a.success("Your profile was updated elsewhere, refreshing view.")}}),()=>{E.current&&E.current.disconnect()}},[f,g]),e.useEffect(()=>{f?t.post("/get-profile",{username:m.username}).then(({data:e})=>{var r;const{personal_info:i,social_links:a={}}=e;j({fullname:i.fullname,email:i.email,username:i.username,bio:i.bio,profile_img:i.profile_img}),k({twitter:a.twitter||"",instagram:a.instagram||"",facebook:a.facebook||"",github:a.github||"",linkedin:a.linkedin||"",website:a.website||""}),_(150-((null==(r=i.bio)?void 0:r.length)||0)),h(!1)}).catch(e=>{a.error("Failed to load profile. Please try again.")}):window.location.href="/signin"},[f,m.username]),e.useEffect(()=>{const e=v.fullname.trim().length>=3,r=/^[a-zA-Z0-9_]{3,20}$/.test(v.username),i=v.bio.length<=150;I({fullname:e,username:r,bio:i}),C(e&&r&&i)},[v]);const F=(e,r)=>{j(i=>({...i,[e]:r}))};return b?s.jsxs(l,{children:[s.jsx(n,{position:"top-center"}),s.jsx(o,{})]}):s.jsxs(l,{children:[s.jsx(n,{position:"top-center"}),s.jsx("form",{onSubmit:async e=>{var r,i,s;if(e.preventDefault(),b)return a.error("Loading data, please wait.");if(!U)return a.error("Please fix validation errors before saving.");w(!0);const l={username:v.username.trim(),fullname:v.fullname.trim(),bio:v.bio.trim(),social_links:{twitter:y.twitter.trim(),instagram:y.instagram.trim(),facebook:y.facebook.trim(),github:y.github.trim(),linkedin:y.linkedin.trim(),website:y.website.trim()}};try{await t.post("/update-profile",l),a.success("Profile updated successfully!"),E.current.emit("forceProfileRefresh",{userId:g})}catch(n){if(422===(null==(r=n.response)?void 0:r.status)&&Array.isArray(n.response.data.errors))n.response.data.errors.forEach(e=>{a.error(e)});else{const e=(null==(s=null==(i=n.response)?void 0:i.data)?void 0:s.error)||"An unexpected error occurred while saving.";a.error(e)}}finally{w(!1)}},className:"max-w-3xl  mx-auto px-4 py-10 sm:px-6",children:s.jsxs("div",{className:"bg-white border-4 dark:bg-black/20 shadow-xl rounded-3xl overflow-hidden backdrop-blur-xl ring-1 ring-cyan-100/30",children:[s.jsxs("div",{className:"bg-gradient-to-br from-blue-900 to-indigo-900 text-white p-6 sm:p-8",children:[s.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Edit Profile"}),s.jsx("p",{className:"text-cyan-100 text-sm mt-1",children:"Craft your online identity"})]}),s.jsxs("div",{className:"p-6 space-y-8",children:[s.jsx("div",{className:"flex justify-center",children:s.jsxs("div",{className:"relative group w-32 h-32 sm:w-40 sm:h-40",children:[s.jsx("img",{ref:A,src:v.profile_img||"/default-profile.png",alt:"Profile",className:"w-full h-full object-cover rounded-full border-4 border-white shadow-lg group-hover:scale-105 transition"}),s.jsxs("label",{htmlFor:"profileImg",className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center rounded-full cursor-pointer transition",children:[s.jsx("i",{className:"fi fi-rr-camera text-white text-xl mb-1"}),s.jsx("span",{className:"text-white text-sm",children:"Change"}),s.jsx("input",{type:"file",name:"profileImg",id:"profileImg",accept:".jpeg,.jpg,.png,.webp,.svg",className:"hidden",onChange:e=>{const r=e.target.files[0];r&&(A.current.src=URL.createObjectURL(r),R(r))}})]})]})}),s.jsx("button",{onClick:async e=>{var r;if(e.preventDefault(),!P)return void a.error("Please choose an image first.");const i=a.loading("Uploading image...");try{const e=await d(P);if(!e||!e.url)throw new Error("Upload failed: no URL returned");v.profile_img;j(r=>({...r,profile_img:e.url}));const s={url:e.url,profile_img:e.url};e.public_id&&(s.public_id=e.public_id,s.publicId=e.public_id,s.cloudinary_id=e.public_id);const l=await t.post("/changeImg",s),n=(null==(r=null==l?void 0:l.data)?void 0:r.profile_img)||e.url,o={...m,profile_img:n};c("user",JSON.stringify(o)),p(o),a.dismiss(i),R(null),a.success("Profile image updated!"),E.current.emit("forceProfileRefresh",{userId:g})}catch(s){j(e=>({...e,profile_img:e.profile_img})),a.dismiss(i),a.error("Failed to update image.")}},disabled:!P,className:"btn-dark mt-5 center  lg:w-[50%] px-10 "+(P?"":"opacity-50 cursor-not-allowed"),children:"Upload Image"}),s.jsxs("div",{className:"grid sm:grid-cols-2 gap-6",children:[s.jsx(u,{name:"fullname",type:"text",label:"Full Name",value:v.fullname,onChange:e=>F("fullname",e.target.value),className:"capitalize",icon:"fi-rr-user",validation:S.fullname,helper:S.fullname?"":"Full name must be at least 3 letters."}),s.jsx(u,{name:"email",type:"email",label:"Email",value:v.email,icon:"fi-rr-envelope",validation:!0,readOnly:!0}),s.jsx(u,{name:"username",type:"text",label:"Username",value:v.username,onChange:e=>F("username",e.target.value),icon:"fi-rr-at",validation:S.username,helper:S.username?"":"3–20 chars; letters, numbers, or underscore only."})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-white mb-1",children:"Bio"}),s.jsx("textarea",{name:"bio",value:v.bio,onChange:e=>{F("bio",e.target.value),_(150-e.target.value.length)},maxLength:150,placeholder:"Describe yourself in 150 characters",className:"w-full h-36 p-3 border rounded-xl shadow-sm bg-white/70 focus:ring-2 focus:ring-cyan-500 resize-none "+(S.bio?"":"border-red-400")}),!S.bio&&s.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Bio must be 150 characters or fewer."}),s.jsxs("p",{className:"text-xs mt-1 text-right text-cyan-600",children:[N,"/150"]})]}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-md font-semibold text-gray-800 dark:text-white mb-3",children:"Social Links"}),s.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:Object.entries({twitter:"fi fi-brands-twitter",instagram:"fi fi-brands-instagram",facebook:"fi fi-brands-facebook",github:"fi fi-brands-github",linkedin:"fi fi-brands-linkedin",website:"fi fi-rr-globe"}).map(([e,r])=>s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("i",{className:`${r} text-xl text-cyan-500`}),s.jsx("input",{name:e,type:"url",value:y[e]||"",onChange:r=>((e,r)=>{k(i=>({...i,[e]:r}))})(e,r.target.value),placeholder:`${e}.com/username`,className:"flex-1 p-2 rounded-lg bg-white/80 border focus:ring-cyan-500 focus:ring-2"})]},e))})]}),s.jsx("div",{className:"pt-6 text-right",children:s.jsx("button",{type:"submit",disabled:!U||x,className:"px-8 py-3 rounded-xl text-white font-bold transition-all duration-300 "+(U&&!x?"bg-gradient-to-r from-cyan-500 to-blue-600 hover:scale-105 shadow-md":"bg-gray-400 cursor-not-allowed"),children:x?"Saving…":"Save Changes"})})]})]})})]})};export{m as default};
